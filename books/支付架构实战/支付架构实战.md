# 支付架构实战

## 第 1 章 : 支付概述

支付牌照(支付业务许可证)

有支付牌照的机构做三方支付业务才是合规的，否则就是所谓的无证机构，是央行严厉打击的对象。目前全国有支付牌照的企业只有 200 多家，它们在央行(中国人民银行)都是有备付金账户的，即客户资金是安全有保障的，且支付金钩可以在此基础上为客户提供资金清算和管理的服务。没有支付牌照也能做支付业务，但没有央行的备付金账户，所以无法进行资金的清算和管理，只能做支付信息服务，我们称之为聚合支付。这样做的目的是保护消费者财产安全，使得市场更加合规稳定

[支付业务流程](./drawio/支付业务流程.drawio){link-type="drawio"}

没有牌照的支付机构需要通过有牌照的支付机构实现资金的流转，并且有牌照的支付机构直接把钱结算给商户，资金不经过聚合支付机构

支付机构核心职责
1. 帮助商户把钱收上来(入金)
1. 把收到的钱结算给商户(出金)

入金: 能够支撑客户的支付能力，把钱从 C 端客户的账户入账到支付机构的账户
出金: 把收到的 C  端客户的钱结算给商户

支付网关是支付的入口，所有交易都要经过支付网关再分发给各个系统，对支付机构起到门户的作用，给接入的商户提供统一的入口，方便商户的接入

商户中心负责管理商户信息，商户想要使用支付平台，就要先提交入驻申请，把营业执照、法人信息、收款账户等上传到支付机构，支付机构存储并管理这些信息，在支付、结算的时候都需要用到这些信息

支付核心负责处理业务逻辑，交易经过支付网关后首先到达支付核心，支付核心根据交易的报文内容去商户中心收集信息，去请求渠道完成支付或者退款，去调用账务完成记账等

账户系统负责管理商户的资金，商户入驻支付机构的时候需要开通一个或多个管理资金的账户，商户使用支付渠道支付的每一笔资金都会在账户中体现，最终结算的时候也从账户中把资金结算给商户

清结算系统负责把收到的资金结算给商户，结算的时候以支付、退款的明细为依据，把商户在支付机构的余额账户中的资金划转到商户的银行卡中

计费系统负责收取渠道的手续费，一方面银联和网联要收取支付机构的手续费，另一方面支付机构会从中获利，是支付机构收入的主要来源

渠道系统负责对接入金和出金的渠道，所有支付机构不能和银行直接交互，需要通过银联/网联与银行交互。聚合支付机构可以对接三方支付机构

## 第 2 章: 支付网关
支付网关是支付机构的关口，所有的支付交易都需要经过支付网关的过滤再分发给各个支付系统，并经由支付渠道转发给银联或者网联。支付网关是支付机构为商户提供的统一接入方式

支付网关作为支付交易的入口，可以把公共处理的模块收拢到支付网关这一层来处理，这样设计的优点:
+ 减轻下游系统压力
+ 系统更加安全
+ 容错能力强

支付网关的业务能力:
1. 统一接入: 作为支付机构最核心的功能，支付网关需要为上游提供统一的接入方式，即接口要统一，不管客户使用哪种支付方式，上游只需要对接一个接口即可
1. 参数校验: 支付网关收到上游的报文之后需要校验参数的合法性，如果参数不合法则要及时丢弃，避免给下游造成压力
1. 加签/验签: 通过验证签名可以验证服务的上游是不是支付机构签约的客户，一来是为资金安全提供保障，二来避免收到不良攻击，另外返回给上游的结果也需要加签
1. 加密/解密: 互联网支付涉及很多隐私信息，如银行卡号、密码等，所以协议传输过程中需要加密，收到协议也需要解密后才能处理，返回给上游的报文也需要加密后才返回
1. 协议转换: 参数校验、验签、解密都通过后，支付网关需要根据特定字段判断将报文转发给哪个系统，转发之前需要按照系统的标准转换为可识别的报文格式
1. 结果反馈: 等待支付系统处理完成之后，支付网关需要接收处理结果并返回给上游

## 第 3 章 : 支付核心

支付核心系统负责串联整个入金流程，支付网关暴露给商户的收款接口都是由支付核心系统定义的，支付核心系统提供预支付、支付、退款、支付结果查询、退款结果查询等接口

[支付核心](./drawio/支付核心.drawio){link-type="drawio"}

## 第 4 章 : 渠道路由
银联诞生之后，三方支付机构只需要对接银联就可以实现对多个银行的支持。银联针对三方支付机构提供了统一支付入口、机构入网、交易清算、对账文件下载、差错处理等功能
### 1. 机构入网
三方支付机构通过银联进行支付交易，需要给银联提供相关的资质信息，银联审批通过后才可以进行交易与交互处理，这个过程成为机构入网，机构入网需要经历 4 步:
1. 注册认证
1. 业务申请
1. 开发自测
1. 投产上线

### 2. 统一支付入口
银联几乎打通了国内所有银行的支付渠道，三方支付机构不需要逐一对接各个银行，只需要对接银联提供的统一接口就可以实现与多家银行的交互
[银联](./drawio/银联.drawio){link-type="drawio"}

### 3. 交易清算
支付机构的交易都通过银联和银行进行交互，银联会通过日清的方式对每个支付机构的交易进行清算，计算给支付机构要结算的资金，央行根据银联计算的结算金额把资金结算到支付机构的备付金账户中

### 4. 对账文件下载
银联会给每个支付机构提供交易的对账文件，通常在 T+1 日把对账文件放到指定的 SFTP 上，三方支付机构到 SFTP 上下载对账文件进行对账

### 5. 差错处理
三方支付机构根据对账文件对出的差错联系银联进行处理，通常是通过线下发邮件的形式来处理这些差错

## 第 6 章 : 清结算和计费

支付的两大核心能力
+ 收款(入金): 把 C 端客户在购买商品时的资金收到了三方支付机构备付金账户中
+ 付款(出金): 三方支付机构把备付金账户中的资金付给售卖商品的商户

清结算系统是三方支付系统按照与商户的协议，把一个结算周期内的收付款项轧差汇总生成待结算金额，并将待结算金额结算给商户的一个功能模块，是支付体系中负责付款模块的一个子系统

清分(clearing)是清算的数据准备阶段，主要将当日的全部网络交易数据按照本代他、他代本、贷记、借记、笔数、金额、轧差净额等进行汇总、整理、分类。清分就是把支付交易数据分门别类地记录、整理、汇总的过程

清算(settlement)不涉及债权债务的转移，而结算(settlement of accounts)是债权债务关系的转移。一般而言，支付活动的过程包括交易、清算和结算。其中清算和结算都是清偿收付双方债权债务关系的过程和手段。在支付活动中，同行内账户往来直接结算便可，而涉及不同行之间的账户资金往来，需要先清算再结算

清算主要是指不同银行间货币收付，可以认为是在进行结算之前，发起行与接收行对支付指令的发送、接收、核对确认，其结果是全面交换结算工具和支付信息，并建立最终结算头寸。清算具有以下几个特点:
+ 清算是用于不同行之间账户资金往来的，同行之间的资金往来无需清算，直接结算即可
+ 清算就是清清楚楚地计算，不同行之间谁付谁多少钱，谁欠谁多少钱，最后再一轧差，得出一个最终谁该付谁多少钱的计算过程
+ 清算包括发起行和接收行对支付指令的发送、接收、核对确认等动作，也就是最后付款之前的一个核对确认动作，确保结算无误
+ 清算不涉及债权债务关系的转移

结算是指将清算过程中产生的待结算头寸分别在发起行、接收行进行相应的会计处理，完成资金转移，并通知收付双方的过程。结算是涉及账户的结算，对结算的定义是完成客户账户间资金划拨的过程

## 第 7 章 : 账务系统

C 端消费者购买商品进行支付，付款的金额会通过三方支付机构送达银联或网联，银联或网联银联转发扣款指令到付款银行卡的发卡行来扣款付款人的付款资金。清算机构会在 T+1 日把支付的金额结算给支付机构，支付机构再把资金结算给售卖商品的商户。结算资金给商户就涉及结算的资金是是多少，结算的资金对应的支付订单是哪些，这些问题可以通过账务系统来统一处理

账务系统最核心的功能是记账，商户通过三方支付机构交易的每一笔订单都可以通过账务系统进行登记入账，账务系统给商户开设一个虚拟的账户，每一笔支付、退款订单都通过账务系统进行记录，清结算系统每天会发起清分，计算当天需要结算给商户的资金，并计入商户的余额账户，然后通过结算任务把余额账户的资金结算到商户的银行卡中


## 第 8 章: 高效的核对体系

支付机构承担管理消费者和商户资金的职责，对账是保证资金安全的最后一道屏障

[支付机构的信息流和资金流](./drawio/支付机构的信息流和资金流.drawio ){link-type="drawio"}

[支付机构内部系统资金流转过程](./drawio/支付机构内部系统资金流转过程.drawio){link-type="drawio"}


